# ADR-001: KOFA MCP Arkitektur

**Status:** Akseptert
**Dato:** 2026-02-05
**Oppdatert:** 2026-02-07 (Phase 2: referanse-ekstraksjon, FOA/LOA-forkortelser)
**Beslutningstagere:** Utviklingsteam
**Kontekst:** MCP-server for KOFA-avgjørelser (Klagenemnda for offentlige anskaffelser)

---

## Sammendrag

KOFA MCP gir Claude/LLM tilgang til ~5000 avgjørelser fra Klagenemnda for offentlige anskaffelser. Serveren synkroniserer data fra KOFAs WordPress-API, ekstraherer PDF-tekst og lovhenvisninger, og eksponerer søk og oppslag via Model Context Protocol.

---

## ADR-001.1: Datakilde

### Kontekst

KOFA publiserer avgjørelser på kofa.no (WordPress-basert). Hver sak har:
- Metadata (parter, sakstype, avgjørelse) i HTML
- Full avgjørelsestekst i PDF

### Alternativer vurdert

| Alternativ | Dekning | Kompleksitet | Pålitelighet |
|------------|---------|--------------|--------------|
| A: WordPress REST API + HTML-scraping | Metadata | Medium | Høy |
| B: Kun PDF-parsing | Alt | Høy | Medium |
| C: Kombinert (WP API → HTML → PDF) | Alt | Høy | Høy |

### Beslutning

**Valgt: C - Tre-stegs pipeline**

```
WP API (saker) → HTML scrape (metadata) → PDF ekstraksjon (fulltekst)
```

### Begrunnelse

- **WP API** gir stabil paginering og endringsdeteksjon (`modified`-felt)
- **HTML scraping** gir strukturerte metadata-felt (innklaget, klager, sakstype, avgjørelse)
- **PDF ekstraksjon** gir full avgjørelsestekst for referanse-ekstraksjon og FTS

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Komplett datamodell |
| Positiv | Inkrementell sync basert på WP `modified` |
| Negativ | Avhengig av KOFAs nettside-struktur |
| Negativ | PDF-parsing kan feile for eldre/skannede dokumenter |

---

## ADR-001.2: Lagringsbackend

### Kontekst

Data deles med paragraf (Lovdata MCP) i samme Supabase-prosjekt. Alle tabeller prefixes med `kofa_`.

### Beslutning

**Valgt: Supabase PostgreSQL (delt instans)**

### Datamodell

```sql
-- Kjernetabeller (001_kofa_schema.sql)
kofa_cases (
    sak_nr TEXT PRIMARY KEY,       -- "2023/1099"
    innklaget, klager, sakstype, avgjoerelse, saken_gjelder,
    summary, pdf_url, avsluttet DATE,
    fts TSVECTOR GENERATED ALWAYS AS (...)  -- Vektet FTS
)

kofa_decision_text (
    sak_nr TEXT REFERENCES kofa_cases,
    paragraph_number INT,
    section TEXT,                   -- "innledning", "bakgrunn", etc.
    text TEXT,
    raw_full_text TEXT              -- Kun på første rad per sak
)

-- Referansetabeller (002_kofa_references.sql)
kofa_law_references (
    sak_nr TEXT REFERENCES kofa_cases,
    law_name TEXT,                  -- Normalisert: "anskaffelsesforskriften"
    law_section TEXT,               -- "8-3", "2-4 bokstav a"
    reference_type TEXT,            -- "lov" | "forskrift"
    lovdata_doc_id TEXT,            -- Kobling til lovdata_documents.dok_id
    raw_text TEXT                   -- Original tekst fra PDF
)

kofa_case_references (
    from_sak_nr TEXT REFERENCES kofa_cases,
    to_sak_nr TEXT,                 -- TEXT, ikke FK (referert sak finnes kanskje ikke)
    paragraph_number INT
)
```

### Indekser

- **FTS:** GIN på `kofa_cases.fts` for fulltekstsøk
- **Trigram:** GIN på `innklaget`/`klager` for fuzzy matching
- **Oppslag:** B-tree på `(law_name, law_section)`, `sak_nr`, `lovdata_doc_id`
- **Kryssref:** B-tree på `from_sak_nr`, `to_sak_nr`

### RLS

Alle tabeller har Row Level Security:
- **Lesing:** Offentlig (public read)
- **Skriving:** Kun `service_role`

---

## ADR-001.3: Arkitektur og lagdeling

### Beslutning

Tre-lags arkitektur med klar ansvarsfordeling:

```
CLI (cli.py) → Service (service.py) → Backend (supabase_backend.py)
     ↓                                        ↑
MCP Server (server.py) ──────────────────────→│
     ↓
Flask Blueprint (web.py) → HTTP POST /mcp/kofa/
```

| Lag | Fil | Ansvar |
|-----|-----|--------|
| **CLI** | `cli.py` | Kommandolinje: `kofa sync`, `kofa sync --pdf`, `kofa sync --references` |
| **Service** | `service.py` | Forretningslogikk, formatering, alias-normalisering |
| **Backend** | `supabase_backend.py` | Database-operasjoner, PostgREST queries |
| **MCP Server** | `server.py` | JSON-RPC protokoll, verktøy-definisjon |
| **Web** | `web.py` | Flask blueprint for HTTP MCP-transport |
| **Ekstraksjon** | `reference_extractor.py` | Regex-basert referanse-ekstraksjon fra PDF-tekst |
| **PDF** | `pdf_extractor.py` | Strukturert ekstraksjon av avgjørelsestekst fra PDF |

### MCP-verktøy

| Verktøy | Beskrivelse |
|---------|-------------|
| `sok(query, limit?)` | Fulltekstsøk i saker |
| `hent_sak(sak_nr)` | Hent en spesifikk sak med alle detaljer |
| `siste_saker(limit?, sakstype?, avgjoerelse?, innklaget?)` | Siste avgjørelser med filtre |
| `finn_praksis(lov, paragraf?, limit?)` | Finn saker som refererer til en bestemt lovparagraf |
| `statistikk(aar?, gruppering?)` | Aggregert statistikk |

### Deployment

KOFA MCP eksponeres som Flask blueprint registrert i unified-timeline:

```python
# backend/app.py
from kofa.web import create_mcp_blueprint as create_kofa_mcp_blueprint
app.register_blueprint(create_kofa_mcp_blueprint(), url_prefix="/mcp/kofa")
```

URL: `https://unified-timeline.onrender.com/mcp/kofa/`

### MCP-instruksjoner

Serveren inkluderer detaljerte instruksjoner som sendes til klienter (LLM) ved tilkobling.
Instruksjonene er designet for å styre LLM-atferd, ikke bare dokumentere API:

| Aspekt | Innhold |
|--------|---------|
| Verktøyvalg | Beslutningstabell: "Bruk `finn_praksis` for lovparagraf, `sok` for tema" |
| Arbeidsflyt | Steg-for-steg: finn praksis → hent detaljer → slå opp lovtekst |
| Utforskning | "ALLTID tilby videre utforskning etter å ha besvart" |
| Samspill | Når bruke KOFA vs Paragraf MCP (tabell) |
| Aliaser | FOA/LOA/forskriften/loven → kanoniske lovnavn |
| Begrensninger | Kun 2020+, ikke rettsavgjørelser, sammendrag vs fulltekst |

Se `server.py:SERVER_INSTRUCTIONS` for full tekst

---

## ADR-001.4: Referanse-ekstraksjon (Phase 2)

### Kontekst

KOFA-avgjørelser refererer hyppig til lover, forskrifter og tidligere KOFA-saker. For å muliggjøre `finn_praksis`-oppslag (f.eks. "finn alle saker om FOA § 8-3") må disse referansene ekstraheres strukturert.

### Alternativer vurdert

| Alternativ | Presisjon | Recall | Kompleksitet |
|------------|-----------|--------|--------------|
| A: LLM-basert ekstraksjon | Høy | Høy | Høy (kostnad, latens) |
| B: Regex-basert ekstraksjon | Høy | Medium-høy | Medium |
| C: Enkel substring-matching | Lav | Høy | Lav |

### Beslutning

**Valgt: B - Regex-basert ekstraksjon med normalisering**

### Begrunnelse

- **Presisjon:** Regex gir svært få falske positiver for strukturerte referanser som `§ X-Y`
- **Kostnad:** Ingen API-kall, ren Python
- **Hastighet:** ~1000 saker/minutt
- **Vedlikehold:** Nye mønstre kan legges til inkrementelt

### Regex-mønstre

Fire mønstre med prioritert rekkefølge (dedup via `seen`-sett):

| Mønster | Eksempel | Beskrivelse |
|---------|----------|-------------|
| 1: Named law + § | `anskaffelsesforskriften § 8-3 (1)` | Lovnavn etterfulgt av paragraf |
| 1b: Abbreviation + § | `FOA § 8-3`, `LOA § 4` | Forkortelse med §-tegn |
| 1c: Abbreviation uten § | `FOA 7-9 (2)` | Forkortelse uten §, krever bindestrek |
| 2: Descriptive | `forskrift om klagenemnd for offentlige anskaffelser § 6` | "lov/forskrift om ..." |
| 3: Case reference | `sak 2019/491`, `klagenemndas sak 2020/172` | KOFA-kryssreferanser |

### Normalisering

Alle lovnavn normaliseres til kanonisk form via `LAW_ALIASES`:

```python
LAW_ALIASES = {
    "forskriften": "anskaffelsesforskriften",
    "loven": "anskaffelsesloven",
    "foa": "anskaffelsesforskriften",
    "loa": "anskaffelsesloven",
    "anskaffelseslova": "anskaffelsesloven",
    "klagenemndforskriften": "klagenemndsforskriften",  # typo
    # ... 20+ aliaser inkl. nynorsk, typos, forkortelser
}
```

Substring-matching er begrenset til multi-ord-aliaser for å unngå falske positiver (`"forskriften"` i `"forsyningsforskriften"` → ignoreres).

### lovdata_doc_id-oppløsning

Referanser kobles til paragraf (Lovdata MCP) via `lovdata_documents.dok_id`:

| Strategi | Dekning |
|----------|---------|
| Hardkodede `KNOWN_DOK_IDS` for de 4 kjernelovene | 100% for anskaffelsesforskriften, anskaffelsesloven, klagenemndsforskriften, offentleglova |
| Dynamisk oppslag via `ilike` for øvrige | Avhenger av om loven er i lovdata-cache |

### Synkresultater (2026-02-07)

| Metrikk | Verdi |
|---------|-------|
| Saker prosessert | 1018 |
| Lovhenvisninger | 3267 |
| Sakskryssreferanser | 1544 |
| lovdata_doc_id resolution | 93.4% |
| Kjernelover resolution | 100% |

### Fordeling lovhenvisninger

| Lov | Antall | lovdata_doc_id |
|-----|--------|----------------|
| klagenemndsforskriften | 1670 | 100% |
| anskaffelsesloven | 625 | 100% |
| anskaffelsesforskriften | 623 | 100% |
| forsyningsforskriften | 182 | 0% (ikke i lovdata-cache) |
| forvaltningsloven | 100 | 100% |
| konsesjonskontraktforskriften | 31 | 0% (ikke i lovdata-cache) |
| offentleglova | 30 | 100% |
| tvisteloven | 3 | 0% |
| konkurranseloven | 2 | 100% |
| sikkerhetsloven | 1 | 0% |

### Scope-avgrensning

Referanse-ekstraksjon dekker kun saker fra **2020+** fordi:
- Gjeldende anskaffelseslov/forskrift er fra 2016
- Eldre saker refererer til opphevede lover med annen paragrafnummerering
- PDF-ekstraksjon (Phase 1) dekker 2020+ saker

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | `finn_praksis("anskaffelsesforskriften", "8-3")` gir presise treff |
| Positiv | Kobling mellom KOFA og paragraf MCP via lovdata_doc_id |
| Positiv | Sakskryssreferanser muliggjør "relaterte saker"-funksjoner |
| Negativ | Regex fanger ikke alle formuleringsmåter (f.eks. "nevnte bestemmelse") |
| Negativ | Kun 2020+ saker dekkes |

---

## ADR-001.5: Sync-strategi

### Pipeline

```
kofa sync                        # Steg 1: WP API → kofa_cases (metadata)
kofa sync --scrape               # Steg 1b: HTML scraping (innklaget, sakstype, etc.)
kofa sync --pdf                  # Steg 2: PDF → kofa_decision_text (fulltekst)
kofa sync --references           # Steg 3: Regex → kofa_law/case_references
kofa sync --references --force   # Re-ekstraher alle (etter regex-endringer)
```

### Inkrementell sync

- **WP API:** Paginerer med `per_page=100`, lagrer cursor i `kofa_sync_meta`
- **PDF:** Hopper over saker som allerede har rader i `kofa_decision_text`
- **Referanser:** Hopper over saker som allerede har rader i `kofa_law_references` (med mindre `--force`)

### Graceful shutdown

Referanse-sync har signalhåndtering (`SIGINT`/`SIGTERM`) som setter `_shutdown_requested`-flagg. Pågående sak fullføres, deretter avsluttes rent med oppsummering.

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Inkrementell - trenger ikke re-synce alt |
| Positiv | `--force` for å re-ekstrahere etter regex-endringer |
| Positiv | Graceful shutdown bevarer dataintegritet |
| Negativ | Tre separate steg krever manuell orkestrering |

---

## Referanser

- [KOFA - Klagenemnda for offentlige anskaffelser](https://www.klagenemndssekretariatet.no/)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [Paragraf ADR-001](../../paragraf/docs/ADR-001.md) - Lovdata MCP arkitektur
