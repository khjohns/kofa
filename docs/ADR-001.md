# ADR-001: KOFA MCP Arkitektur

**Status:** Akseptert
**Dato:** 2026-02-05
**Oppdatert:** 2026-02-10 (Phase 2: referanse-ekstraksjon, reguleringsversjon, kryssreferanser, EU-dommer, domstolsreferanser, bare §-kontekstpropagering, datakvalitet, hent_avgjoerelse, FTS+vektorsøk, seksjonsfiks)
**Beslutningstagere:** Utviklingsteam
**Kontekst:** MCP-server for KOFA-avgjørelser (Klagenemnda for offentlige anskaffelser)

---

## Sammendrag

KOFA MCP gir Claude/LLM tilgang til ~5000 avgjørelser fra Klagenemnda for offentlige anskaffelser. Serveren synkroniserer data fra KOFAs WordPress-API, ekstraherer PDF-tekst og lovhenvisninger, og eksponerer søk og oppslag via Model Context Protocol.

---

## ADR-001.1: Datakilde

### Kontekst

KOFA publiserer avgjørelser på kofa.no (WordPress-basert). Hver sak har:
- Metadata (parter, sakstype, avgjørelse) i HTML
- Full avgjørelsestekst i PDF

### Alternativer vurdert

| Alternativ | Dekning | Kompleksitet | Pålitelighet |
|------------|---------|--------------|--------------|
| A: WordPress REST API + HTML-scraping | Metadata | Medium | Høy |
| B: Kun PDF-parsing | Alt | Høy | Medium |
| C: Kombinert (WP API → HTML → PDF) | Alt | Høy | Høy |

### Beslutning

**Valgt: C - Tre-stegs pipeline**

```
WP API (saker) → HTML scrape (metadata) → PDF ekstraksjon (fulltekst)
```

### Begrunnelse

- **WP API** gir stabil paginering og endringsdeteksjon (`modified`-felt)
- **HTML scraping** gir strukturerte metadata-felt (innklaget, klager, sakstype, avgjørelse)
- **PDF ekstraksjon** gir full avgjørelsestekst for referanse-ekstraksjon og FTS

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Komplett datamodell |
| Positiv | Inkrementell sync basert på WP `modified` |
| Negativ | Avhengig av KOFAs nettside-struktur |
| Negativ | PDF-parsing kan feile for eldre/skannede dokumenter |

---

## ADR-001.2: Lagringsbackend

### Kontekst

Data deles med paragraf (Lovdata MCP) i samme Supabase-prosjekt. Alle tabeller prefixes med `kofa_`.

### Beslutning

**Valgt: Supabase PostgreSQL (delt instans)**

### Datamodell

```sql
-- Kjernetabeller (001_kofa_schema.sql)
kofa_cases (
    sak_nr TEXT PRIMARY KEY,       -- "2023/1099"
    innklaget, klager, sakstype, avgjoerelse, saken_gjelder,
    summary, pdf_url, avsluttet DATE,
    fts TSVECTOR GENERATED ALWAYS AS (...)  -- Vektet FTS
)

kofa_decision_text (
    sak_nr TEXT REFERENCES kofa_cases,
    paragraph_number INT,
    section TEXT,                   -- "innledning", "bakgrunn", etc.
    text TEXT,
    raw_full_text TEXT              -- Kun på første rad per sak
)

-- Referansetabeller (002_kofa_references.sql)
kofa_law_references (
    sak_nr TEXT REFERENCES kofa_cases,
    law_name TEXT,                  -- Normalisert: "anskaffelsesforskriften"
    law_section TEXT,               -- "8-3", "2-4 bokstav a"
    reference_type TEXT,            -- "lov" | "forskrift"
    regulation_version TEXT,        -- "old" (pre-2017) | "new" (2017+)
    raw_text TEXT                   -- Original tekst fra PDF
)

kofa_case_references (
    from_sak_nr TEXT REFERENCES kofa_cases,
    to_sak_nr TEXT,                 -- TEXT, ikke FK (referert sak finnes kanskje ikke)
    paragraph_number INT
)

-- EU-domstolsreferanser (005_eu_references.sql)
kofa_eu_references (
    sak_nr TEXT REFERENCES kofa_cases,
    eu_case_id TEXT,                -- "C-19/00"
    eu_case_name TEXT,              -- "SIAC Construction" (kan være NULL)
    paragraph_number INT
)

-- Norske domstolsreferanser (006_court_references.sql)
kofa_court_references (
    sak_nr TEXT REFERENCES kofa_cases,
    court_case_id TEXT,             -- "HR-2019-1801-A", "Rt-2007-983", "LB-2019-85112"
    court_level TEXT,               -- "hoyesterett", "lagmannsrett", "tingrett"
    court_name TEXT,                -- "Høyesterett", "Borgarting lagmannsrett"
    paragraph_number INT,
    raw_text TEXT
)
```

### Indekser

- **FTS:** GIN på `kofa_cases.fts` for fulltekstsøk
- **Trigram:** GIN på `innklaget`/`klager` for fuzzy matching
- **Oppslag:** B-tree på `(law_name, law_section)`, `sak_nr`
- **Kryssref:** B-tree på `from_sak_nr`, `to_sak_nr`
- **EU-ref:** B-tree på `eu_case_id`, `sak_nr`
- **Domstolsref:** B-tree på `court_case_id`, `sak_nr`

### RLS

Alle tabeller har Row Level Security:
- **Lesing:** Offentlig (public read)
- **Skriving:** Kun `service_role`

---

## ADR-001.3: Arkitektur og lagdeling

### Beslutning

Tre-lags arkitektur med klar ansvarsfordeling:

```
CLI (cli.py) → Service (service.py) → Backend (supabase_backend.py)
     ↓                                        ↑
MCP Server (server.py) ──────────────────────→│
     ↓
Flask Blueprint (web.py) → HTTP POST /mcp/kofa/
```

| Lag | Fil | Ansvar |
|-----|-----|--------|
| **CLI** | `cli.py` | Kommandolinje: `kofa sync`, `kofa sync --pdf`, `kofa sync --references` |
| **Service** | `service.py` | Forretningslogikk, formatering, alias-normalisering |
| **Backend** | `supabase_backend.py` | Database-operasjoner, PostgREST queries |
| **MCP Server** | `server.py` | JSON-RPC protokoll, verktøy-definisjon |
| **Web** | `web.py` | Flask blueprint for HTTP MCP-transport |
| **Ekstraksjon** | `reference_extractor.py` | Regex-basert referanse-ekstraksjon fra PDF-tekst |
| **PDF** | `pdf_extractor.py` | Strukturert ekstraksjon av avgjørelsestekst fra PDF |

### MCP-verktøy

| Verktøy | Beskrivelse |
|---------|-------------|
| `sok(query, limit?)` | Fulltekstsøk i saker |
| `hent_sak(sak_nr)` | Hent en spesifikk sak med alle detaljer |
| `hent_avgjoerelse(sak_nr, seksjon?)` | Hent avgjørelsestekst (innledning, bakgrunn, anførsler, vurdering, konklusjon) |
| `siste_saker(limit?, sakstype?, avgjoerelse?, innklaget?)` | Siste avgjørelser med filtre |
| `finn_praksis(lov, paragraf?, limit?)` | Finn saker som refererer til en bestemt lovparagraf |
| `relaterte_saker(sak_nr)` | Kryssreferanser: saker denne saken siterer og saker som siterer denne |
| `mest_siterte(limit?)` | De mest siterte/prinsipielle KOFA-sakene |
| `eu_praksis(eu_case_id, limit?)` | Finn KOFA-saker som refererer til en bestemt EU-dom |
| `mest_siterte_eu(limit?)` | De mest siterte EU-dommene i KOFA |
| `sok_avgjoerelse(query, seksjon?, limit?)` | Fulltekstsøk i avgjørelsestekst |
| `semantisk_sok_kofa(query, seksjon?, limit?)` | Semantisk søk med AI-embeddings i avgjørelsestekst |
| `statistikk(aar?, gruppering?)` | Aggregert statistikk |

### Deployment

KOFA MCP eksponeres som Flask blueprint registrert i unified-timeline:

```python
# backend/app.py
from kofa.web import create_mcp_blueprint as create_kofa_mcp_blueprint
app.register_blueprint(create_kofa_mcp_blueprint(), url_prefix="/mcp/kofa")
```

URL: `https://unified-timeline.onrender.com/mcp/kofa/`

### MCP-instruksjoner

Serveren inkluderer detaljerte instruksjoner som sendes til klienter (LLM) ved tilkobling.
Instruksjonene er designet for å styre LLM-atferd, ikke bare dokumentere API:

| Aspekt | Innhold |
|--------|---------|
| Verktøyvalg | Beslutningstabell: "Bruk `finn_praksis` for lovparagraf, `sok` for tema" |
| Arbeidsflyt | Steg-for-steg: finn praksis → hent detaljer → slå opp lovtekst |
| Utforskning | "ALLTID tilby videre utforskning etter å ha besvart" |
| Samspill | Når bruke KOFA vs Paragraf MCP (tabell) |
| Aliaser | FOA/LOA/forskriften/loven → kanoniske lovnavn |
| Begrensninger | Saker uten PDF-tekst (~920) har kun metadata, ikke rettsavgjørelser |

Se `server.py:SERVER_INSTRUCTIONS` for full tekst

---

## ADR-001.4: Referanse-ekstraksjon (Phase 2)

### Kontekst

KOFA-avgjørelser refererer hyppig til lover, forskrifter og tidligere KOFA-saker. For å muliggjøre `finn_praksis`-oppslag (f.eks. "finn alle saker om FOA § 8-3") må disse referansene ekstraheres strukturert.

### Alternativer vurdert

| Alternativ | Presisjon | Recall | Kompleksitet |
|------------|-----------|--------|--------------|
| A: LLM-basert ekstraksjon | Høy | Høy | Høy (kostnad, latens) |
| B: Regex-basert ekstraksjon | Høy | Medium-høy | Medium |
| C: Enkel substring-matching | Lav | Høy | Lav |

### Beslutning

**Valgt: B - Regex-basert ekstraksjon med normalisering**

### Begrunnelse

- **Presisjon:** Regex gir svært få falske positiver for strukturerte referanser som `§ X-Y`
- **Kostnad:** Ingen API-kall, ren Python
- **Hastighet:** ~1000 saker/minutt
- **Vedlikehold:** Nye mønstre kan legges til inkrementelt

### Regex-mønstre

Syv mønstergrupper med dedup via `seen`-sett:

| Mønster | Eksempel | Beskrivelse |
|---------|----------|-------------|
| 1: Named law + § | `anskaffelsesforskriften § 8-3 (1)` | Lovnavn etterfulgt av paragraf, støtter `(YYYY)` årstall og `del III` |
| 1b: Abbreviation + § | `FOA § 8-3`, `LOA § 4` | Forkortelse med §-tegn |
| 1c: Abbreviation uten § | `FOA 7-9 (2)` | Forkortelse uten §, krever bindestrek |
| 2: Descriptive | `forskrift om klagenemnd for offentlige anskaffelser § 6` | "lov/forskrift om ..." |
| D: Bare § (kontekst) | `jf. § 16-10`, `se § 24-8 første ledd` | Bare §-ref uten lovnavn — lovnavn infereres fra kontekst |
| 3: Case reference | `sak 2019/491`, `klagenemndas sak 2020/172` | KOFA-kryssreferanser |
| 4: EU case | `C-19/00 SIAC Construction`, `C-368/10 (Max Havelaar)` | EU-domstolsreferanser med navnekstraksjon |
| 5: Court case | `HR-2019-1801-A`, `Rt. 2007 s. 983`, `LB-2019-85112` | Norske domstolsreferanser (HR, lagmannsrett, tingrett) |

### Normalisering

Alle lovnavn normaliseres til kanonisk form via `LAW_ALIASES`:

```python
LAW_ALIASES = {
    "forskriften": "anskaffelsesforskriften",
    "loven": "anskaffelsesloven",
    "foa": "anskaffelsesforskriften",
    "loa": "anskaffelsesloven",
    "anskaffelseslova": "anskaffelsesloven",
    "klagenemndforskriften": "klagenemndsforskriften",  # typo
    # ... 20+ aliaser inkl. nynorsk, typos, forkortelser
}
```

Substring-matching er begrenset til multi-ord-aliaser for å unngå falske positiver (`"forskriften"` i `"forsyningsforskriften"` → ignoreres).

### Kontekst-propagering for bare §-referanser (Pattern D)

KOFA-avgjørelser bruker hyppig bare `§ X-Y` uten lovnavn — lovnavnet er implisitt fra konteksten. `ReferenceExtractor` holder tilstand og løser disse i tre nivåer:

| Nivå | Kilde | Eksempel |
|------|-------|----------|
| 1: Samme avsnitt | Nærmeste foranstående navngitte ref | «forskriften § 16-10 … jf. § 16-7» → FOA |
| 2: Forrige avsnitt | Cross-paragraph kontekst | Forrige avsnitt nevnte FOA → arves |
| 3: KOFA-heuristikk | Bindestrek-seksjoner (X-Y) → FOA | «§ 24-8» uten kontekst → FOA |

Enkle seksjonsnumre (§ 12) uten kontekst hoppes over — for tvetydige (forvaltningsloven, LOA, etc.). `reset_context()` kalles mellom saker for å unngå kontekstlekkasje.

### Reguleringsversjon (gammel/ny forskrift)

Ny anskaffelseslov (2016-06-17-73) og ny forskrift (2016-08-12-974) trådte i kraft 1.1.2017. KOFA-saker fra overgangsperioden (2017-2019) kan anvende enten gammelt eller nytt regelverk. Deteksjon per sak via `detect_regulation_version()`:

| Signal | Klassifisering |
|--------|---------------|
| Eksplisitt ny lov/forskrift (dato/nr) | `new` |
| Eksplisitt gammel + eksplisitt ny | `new` (gammel er historisk kontekst) |
| "den tidligere" / "dagjeldende" i 2018+ | `new` (historisk kontekst) |
| "den tidligere" / "dagjeldende" i 2017 | `old` (overgangsperiode) |
| Ingen signaler + saksnr ≤ 2016 | `old` |
| Ingen signaler + saksnr ≥ 2017 | `new` |

### Synkresultater (2026-02-10, full re-ekstraksjon)

| Metrikk | Verdi |
|---------|-------|
| Saker prosessert | 3 668 (alle med PDF-tekst) |
| Lovhenvisninger | 25 890 (3 254 unike saker) |
| Sakskryssreferanser | 6 602 (2 436 unike saker) |
| EU-referanser | 1 867 (1 005 unike saker) |
| Domstolsreferanser | 1 374 (812 unike saker) |
| Unike domstolssaker | 191 |
| Unike EU-saker | 211 |

Lovhenvisninger økte fra ~7 400 (2026-02-09) til ~25 900 etter tre forbedringer:
1. Regex-fix for kortformer, del-referanser og parentes uten mellomrom (+~10 600)
2. Bare §-referanser med kontekst-propagering (+~7 900)
3. Støtte for `(YYYY)` årstall-kvalifikator i lovnavn

`detect_regulation_version()` klassifiserer gammel/ny forskrift korrekt for alle årganger. 367 dangling cross-refs (forventet — refererte saker uten PDF).

### Fordeling lovhenvisninger

| Lov | Antall | Saker |
|-----|--------|-------|
| anskaffelsesforskriften | 14 978 | 2 979 |
| klagenemndsforskriften | 6 929 | 2 896 |
| anskaffelsesloven | 2 543 | 1 802 |
| forsyningsforskriften | 622 | 168 |
| forvaltningsloven | 416 | 204 |
| offentleglova | 240 | 146 |
| tvisteloven | 73 | 31 |
| konsesjonskontraktforskriften | 38 | 17 |
| konkurranseloven | 22 | 13 |
| straffeloven | 21 | 2 |
| avtaleloven | 14 | 4 |
| sikkerhetsloven | 5 | 2 |

FOA er nå klart størst (14 978) takket være bare §-referanser med kontekst-propagering — mange FOA-seksjoner nevnes med bare `§ X-Y` etter at forskriften er navngitt tidligere i teksten.

Kobling til lovtekst gjøres at runtime via paragraf MCP (`lov()`-verktøyet), ikke via lagret kobling.

### Topp 10 EU-dommer i KOFA

| EU-sak | Navn | KOFA-siteringer |
|--------|------|-----------------|
| C-19/00 | SIAC Construction | 222 |
| C-448/01 | Wienström | 108 |
| C-532/06 | Lianakis | 103 |
| C-454/06 | Pressetext | 93 |
| C-42/13 | Cartiera dell'Adda | 65 |
| C-6/15 | TNS Dimarso | 63 |
| C-368/10 | Max Havelaar | 55 |
| C-27/15 | Pippo Pizzo | 36 |
| C-331/04 | ATI EAC | 35 |
| C-27/98 | Metalmeccanica | 33 |

### Datakvalitet og kjente edge cases

Verifisert 2026-02-08 via direkte SQL-analyse mot produksjonsdata:

**Funnet og fikset:**

| Problem | Antall | Fix |
|---------|--------|-----|
| Selv-referanser i sakskryssreferanser | 4 | Filter `from_sak_nr != to_sak_nr` i Python + SQL-sletting |
| Linjeskift i EU-saksnavn (PDF-artefakt) | 35 | `_clean_eu_case_name()` stripper `\n` og sidetall |
| Trailing connector i EU-navn ("Montte og") | 6 | Strip trailing `og`/`mot`/`v.`/`et` |
| LOA→FOA misattribusjon | 6 | KOFA skriver noen ganger "loven" for forskrift-seksjoner. Automatisk korreksjon: LOA-ref med sammensatt seksjon (§ 24-8) eller seksjon > 18 remappes til FOA |
| EU appeal-suffiks "P" som saksnavn | 4 | Forkast entegns-navn (C-677/15P → "P" er ikke et saksnavn) |
| Feilsiterte EU-IDer i kildetekst | 5 | C-15/6→C-6/15, C-19/99→C-19/00 (korrigert i SQL) |

**Kjent og akseptert:**

| Observasjon | Antall | Vurdering |
|-------------|--------|-----------|
| Dangling cross-refs (peker til saker uten tekst) | 367 | Forventet — noen refererte saker mangler PDF |
| Saker med tekst men null referanser | 27 | Korte avvisningssaker uten lovhenvisninger |
| EU-navnevarianter per case_id | ~10 saker | Korrekt oppførsel — kildetekst varierer ("SIAC" vs "SIAC Construction") |
| "Max Havelaar og Rt" (2 stk) | 2 | "Rt." (Rettstidende) fanges som del av navn — ikke verdt spesialregel |

### Scope

Referanse-ekstraksjon dekker **alle saker med PDF-tekst** (~3700 saker, 2003–2025):
- `detect_regulation_version()` klassifiserer gammel/ny forskrift basert på tekstmønstre + årstall-fallback
- Saker som anvender gammel lov merkes med `regulation_version = "old"`
- Ny anskaffelseslov er ventet i 2026 — vil kreve tilpasning av seksjonsnummerlogikk

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | `finn_praksis("anskaffelsesforskriften", "8-3")` gir presise treff |
| Positiv | Sakskryssreferanser muliggjør `relaterte_saker` og `mest_siterte` |
| Positiv | Reguleringsversjon skiller gammel/ny forskrift i overgangsperioden |
| Positiv | EU-referanser med navnekstraksjon muliggjør `eu_praksis` og `mest_siterte_eu` |
| Positiv | Automatisk LOA→FOA-korreksjon håndterer feil i kildetekst |
| Positiv | Domstolsreferanser (HR, lagmannsrett, tingrett) muliggjør kobling til norsk rettspraksis |
| Positiv | Bare §-kontekstpropagering fanger ~8 000 ekstra lovhenvisninger |
| Negativ | Regex fanger ikke alle formuleringsmåter (f.eks. "nevnte bestemmelse") |
| Negativ | Eldre PDFer (pre-2013) har lavere seksjoneringsrate — 322 raw-only |

---

## ADR-001.5: Sync-strategi

### Pipeline

```
kofa sync                        # Steg 1: WP API → kofa_cases (metadata)
kofa sync --scrape               # Steg 1b: HTML scraping (innklaget, sakstype, etc.)
kofa sync --pdf                  # Steg 2: PDF → kofa_decision_text (fulltekst)
kofa sync --references           # Steg 3: Regex → kofa_law/case_references
kofa sync --references --force   # Re-ekstraher alle (etter regex-endringer)
```

### Inkrementell sync

- **WP API:** Paginerer med `per_page=100`, lagrer cursor i `kofa_sync_meta`
- **PDF:** Hopper over saker som allerede har rader i `kofa_decision_text`
- **Referanser:** Hopper over saker som allerede har rader i `kofa_law_references` (med mindre `--force`)

### Graceful shutdown

Referanse-sync har signalhåndtering (`SIGINT`/`SIGTERM`) som setter `_shutdown_requested`-flagg. Pågående sak fullføres, deretter avsluttes rent med oppsummering.

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Inkrementell - trenger ikke re-synce alt |
| Positiv | `--force` for å re-ekstrahere etter regex-endringer |
| Positiv | Graceful shutdown bevarer dataintegritet |
| Negativ | Tre separate steg krever manuell orkestrering |

---

## ADR-001.6: Datadekning og veien videre

### Nåværende datadekning (2026-02-09)

| Pipeline | Rader | Dekning |
|----------|------:|---------|
| Saker (WP API) | 4 652 | 100% (baseline) |
| Scraping (HTML) | 4 652 | 100% |
| PDF-URL | 3 730 | 80% av saker |
| PDF-tekst ekstrahert | 3 670 | 79% (98% av de med PDF-URL) |
| Seksjonsinndelt | 3 348 | 72% |
| Raw-only (uten seksjoner) | 322 | Hovedsakelig pre-2013 |
| PDF med mislykket ekstraksjon | 60 | Sannsynligvis skannede bilder |
| Lovreferanser | 25 890 | 3 254 unike saker |
| Sakskryssreferanser | 6 602 | 2 436 unike saker |
| EU-referanser | 1 867 | 1 005 unike saker |
| Domstolsreferanser | 1 374 | 812 unike saker |

#### Seksjonfordeling i avgjørelsestekst (etter seksjonsfiks 2026-02-09)

| Section | Avsnitt | % |
|---------|--------:|---:|
| vurdering | 37 395 | 46.9 |
| bakgrunn | 28 543 | 35.8 |
| anfoersler | 13 105 | 16.5 |
| innledning | 534 | 0.7 |
| raw | 59 | 0.1 |
| konklusjon | 22 | 0.0 |

#### Indeksering

| Tabell | FTS | Vektorsøk |
|--------|-----|-----------|
| `kofa_cases` | `fts` (vektet tsvector) | Ingen |
| `kofa_decision_text` | `search_vector` + GIN | `embedding` VECTOR(1536), IVFFlat (etter embedding-generering) |
| `lovdata_sections` (referanse) | `search_vector` + GIN | `embedding` VECTOR(1536), 98% dekning, IVFFlat |

#### Ytelse `hent_avgjoerelse` (målt 2026-02-08)

Queries bruker `idx_kofa_decision_text_sak` (B-tree) med index scan. Ingen seq scans.

| Scenario | Execution time | Rader |
|----------|---------------|------:|
| TOC - typisk sak (84 avsnitt) | **0.20 ms** | 84 |
| Seksjon - typisk vurdering (63 avsnitt) | **0.20 ms** | 63 |
| Seksjon - største vurdering (75 avsnitt, ~10k tokens) | **0.24 ms** | 75 |
| TOC - største sak (147 avsnitt) | **0.32 ms** | 147 |

**Størrelsesdistribusjon (avsnitt per sak):**

| Percentil | Avsnitt |
|-----------|--------:|
| Median | 38 |
| P90 | 67 |
| P95 | 79 |
| P99 | 106 |
| Max | 216 |

**Token-størrelse:** Største vurderingsseksjon er ~10k tokens. Hele saker kan nå ~36k tokens (samlesaker fra 2012). TOC-modusen lar LLM velge seksjon og unngå unødvendig store kontekster.

**Dobbel-query:** `get_case()` + `get_decision_text()` gir ~2x nettverkslatens (~100-400ms totalt), neglisjerbart mot LLM-responstid. LIMIT 500 treffes aldri (max er 216).

**Tabellstørrelse:** 57 MB data + 5 MB indekser. Ingen ytelsestiltak nødvendige.

### Veien videre

| Fase | Beskrivelse | Status |
|------|-------------|--------|
| A: `hent_avgjoerelse` | MCP-verktøy for å lese avgjørelsestekst | Implementert |
| B: FTS på avgjørelsestekst | `search_vector` + GIN-indeks på `kofa_decision_text` | Implementert |
| C: Vektorsøk (embedding) | pgvector embeddings + hybrid søk (som lovdata) | Kode klar, embedding-generering gjenstår |

Se ADR-001.7 for detaljer om fase B+C.

---

## ADR-001.7: FTS og vektorsøk på avgjørelsestekst (Fase B+C)

### Kontekst

KOFA-avgjørelsesteksten (79 658 avsnitt) hadde ingen søkefunksjonalitet — kun metadata-FTS på `kofa_cases.fts`. For å la LLM finne relevante avgjørelser basert på innholdet i selve begrunnelsene trengs:
1. FTS for eksakte juridiske termer ("vesentlig avvik", "avvisningsplikt")
2. Vektorsøk for naturlig språk og synonymer ("ulovlig direkte anskaffelse" -> kunngjøringsplikt)

### Beslutning

**Valgt: Hybrid FTS + vektorsøk (samme mønster som lovdata)**

Gjenbruker arkitekturen fra paragraf-prosjektet (`search_lovdata_hybrid`) tilpasset KOFA:

| Komponent | Lovdata (referanse) | KOFA |
|-----------|--------------------:|-----:|
| Tabell | `lovdata_sections` | `kofa_decision_text` |
| Rader | 90 253 | ~79 600 |
| Snitt tekstlengde | ~800 tegn | ~425 tegn |
| Embedding-modell | Gemini gemini-embedding-001 | Gemini gemini-embedding-001 |
| Dimensjoner | 1536 | 1536 |
| Vektor-indeks | IVFFlat (lists=100) | IVFFlat (lists=100) |
| FTS-vekt (hybrid) | 0.5 | 0.3 |
| FTS-query | `websearch_to_tsquery` | `websearch_to_tsquery` |

### FTS-vekt 0.3 (ikke 0.5)

KOFA-avsnitt er kortere enn lovparagrafer (snitt 425 vs ~800 tegn). Kortere tekst gir lavere og mer varierende `ts_rank`-verdier, som gjør FTS-komponenten noisier. Default 0.3 vekter vektorsøk høyere (70% vektor, 30% FTS).

### Database-endringer

**Migration: `add_fts_and_embedding_to_decision_text`**
- `search_vector TSVECTOR` — auto-populert via trigger
- `embedding vector(1536)` — for Gemini-embeddings
- `content_hash TEXT` — for inkrementell embedding-sync
- GIN-indeks på `search_vector`
- Trigger `kofa_decision_text_search_trigger` på INSERT/UPDATE

**Migration: `add_kofa_decision_search_functions`**
- `search_kofa_decision_text(query, section_filter, max_results)` — ren FTS
- `search_kofa_decision_hybrid(query_text, query_embedding, section_filter, match_count, fts_weight, ivfflat_probes)` — hybrid
- `batch_update_kofa_embeddings(ids, embeddings, content_hashes)` — for embedding-script

**IVFFlat-indeks** bygges etter embedding-generering (krever data for clustering).

### Nye MCP-verktøy

| Verktøy | Beskrivelse | Backend |
|---------|-------------|---------|
| `sok_avgjoerelse(query, seksjon?, limit?)` | FTS i avgjørelsestekst | `search_kofa_decision_text` RPC |
| `semantisk_sok_kofa(query, seksjon?, limit?)` | Hybrid vektor+FTS søk | `search_kofa_decision_hybrid` RPC |

### Kodestruktur

| Fil | Rolle |
|-----|-------|
| `scripts/embed_kofa.py` | Embedding-generering (Gemini, batch 100, parallell) |
| `src/kofa/vector_search.py` | `KofaVectorSearch` — hybrid søk med FTS-fallback |
| `src/kofa/supabase_backend.py` | `search_decision_text()` — FTS via RPC |
| `src/kofa/service.py` | `search_decision_text()`, `semantic_search()` — formatering |
| `src/kofa/server.py` | MCP-verktøydefinisjoner + dispatch |
| `src/kofa/cli.py` | `kofa sync --embeddings` kommando |

### Embedding-generering

```bash
# Verifiser først
python scripts/embed_kofa.py --dry-run

# Generer (tar ~2 timer, ~$2)
python scripts/embed_kofa.py --workers 3

# For Supabase free tier
python scripts/embed_kofa.py --workers 1 --max-time 25
```

Kontekst-enrichment for bedre embedding-kvalitet:
```
KOFA sak 2023/1099 — Klagenemndas vurdering

[avsnittets tekst]
```

### Datakvalitetsverifisering (2026-02-09)

Statistisk analyse av 79 658 avsnitt + stratifiserte stikkprøver (6 saker, 3 epoker) før embedding-generering.

**Statistiske funn:**

| Metrikk | Verdi | Vurdering |
|---------|-------|-----------|
| Avsnitt totalt (non-raw) | 79 599 | |
| Tomme tekster | 0 | OK |
| Korte (<10 tegn) | 53 (0.07%) | Neglisjerbart — standalone avsnittnummer fra 2013 |
| Lange (>5000 tegn) | 15 | OK — reelt innhold (kravspekk, evalueringsrapporter) |
| Lange (>8000 tegn) | 3 | Trunkeres av Gemini (2048 tokens), akseptabelt |
| P99 tekstlengde | 1 587 tegn | Godt innenfor embedding-grense |
| Max tekstlengde | 16 580 tegn | Én kravspekk-paragraf (2013/37) |
| Duplikat-avsnitt | ~20 saker (dupes=2) | Neglisjerbart |
| Nummererings-feil | 0 | Perfekt |
| Encoding-feil | 0 | Perfekt |
| PDF-artefakter | 4 korte headers | Neglisjerbart |
| Raw-only saker (skippes) | 59 | Korrekt filtrert av embed-skriptet |

**Seksjonsfeil funnet og fikset:**

`_assign_sections()` i `pdf_extractor.py` brukte regex med valgfri kolon for seksjons-nøkkelord. Enkeltord som "bakgrunn" og "anførsler" er vanlige norske ord som kan havne alene på en linje pga. PDF-linjeskift, og ble da feilaktig tolket som seksjonsoverskrifter.

| | Før fix | Etter fix |
|---|---|---|
| Saker med seksjons-overlapp | 99 (5.3%) | 3 (kun 2012/20-22) |
| Feilklassifiserte avsnitt | ~400 | 0 (unntatt 2012/20-22) |

**Fix:** Enkeltord-nøkkelord krever nå kolon (`bakgrunn:`, `anførsler:`). Flerord-nøkkelord (`klagenemndas vurdering`) matcher fortsatt uten kolon. 396 eksisterende avsnitt rettet direkte i SQL. 2012/20-22 (samlesak med fullstendig ødelagt seksjonering, 216 avsnitt, 176 feilmerket som `innledning`) fikses ved neste `kofa sync --pdf --force`.

### Gjenstår

- [ ] Kjøre `python scripts/embed_kofa.py` (~80k avsnitt, ~2 timer)
- [ ] Bygge IVFFlat-indeks etter embedding er komplett
- [ ] Ytelsesmålinger av hybrid søk

---

## Referanser

- [KOFA - Klagenemnda for offentlige anskaffelser](https://www.klagenemndssekretariatet.no/)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [Paragraf ADR-001](../../paragraf/docs/ADR-001.md) - Lovdata MCP arkitektur
