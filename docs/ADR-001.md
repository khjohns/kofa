# ADR-001: KOFA MCP Arkitektur

**Status:** Akseptert
**Dato:** 2026-02-05
**Oppdatert:** 2026-02-08 (Phase 2: referanse-ekstraksjon, reguleringsversjon, kryssreferanser, EU-dommer, datakvalitet, hent_avgjoerelse)
**Beslutningstagere:** Utviklingsteam
**Kontekst:** MCP-server for KOFA-avgjørelser (Klagenemnda for offentlige anskaffelser)

---

## Sammendrag

KOFA MCP gir Claude/LLM tilgang til ~5000 avgjørelser fra Klagenemnda for offentlige anskaffelser. Serveren synkroniserer data fra KOFAs WordPress-API, ekstraherer PDF-tekst og lovhenvisninger, og eksponerer søk og oppslag via Model Context Protocol.

---

## ADR-001.1: Datakilde

### Kontekst

KOFA publiserer avgjørelser på kofa.no (WordPress-basert). Hver sak har:
- Metadata (parter, sakstype, avgjørelse) i HTML
- Full avgjørelsestekst i PDF

### Alternativer vurdert

| Alternativ | Dekning | Kompleksitet | Pålitelighet |
|------------|---------|--------------|--------------|
| A: WordPress REST API + HTML-scraping | Metadata | Medium | Høy |
| B: Kun PDF-parsing | Alt | Høy | Medium |
| C: Kombinert (WP API → HTML → PDF) | Alt | Høy | Høy |

### Beslutning

**Valgt: C - Tre-stegs pipeline**

```
WP API (saker) → HTML scrape (metadata) → PDF ekstraksjon (fulltekst)
```

### Begrunnelse

- **WP API** gir stabil paginering og endringsdeteksjon (`modified`-felt)
- **HTML scraping** gir strukturerte metadata-felt (innklaget, klager, sakstype, avgjørelse)
- **PDF ekstraksjon** gir full avgjørelsestekst for referanse-ekstraksjon og FTS

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Komplett datamodell |
| Positiv | Inkrementell sync basert på WP `modified` |
| Negativ | Avhengig av KOFAs nettside-struktur |
| Negativ | PDF-parsing kan feile for eldre/skannede dokumenter |

---

## ADR-001.2: Lagringsbackend

### Kontekst

Data deles med paragraf (Lovdata MCP) i samme Supabase-prosjekt. Alle tabeller prefixes med `kofa_`.

### Beslutning

**Valgt: Supabase PostgreSQL (delt instans)**

### Datamodell

```sql
-- Kjernetabeller (001_kofa_schema.sql)
kofa_cases (
    sak_nr TEXT PRIMARY KEY,       -- "2023/1099"
    innklaget, klager, sakstype, avgjoerelse, saken_gjelder,
    summary, pdf_url, avsluttet DATE,
    fts TSVECTOR GENERATED ALWAYS AS (...)  -- Vektet FTS
)

kofa_decision_text (
    sak_nr TEXT REFERENCES kofa_cases,
    paragraph_number INT,
    section TEXT,                   -- "innledning", "bakgrunn", etc.
    text TEXT,
    raw_full_text TEXT              -- Kun på første rad per sak
)

-- Referansetabeller (002_kofa_references.sql)
kofa_law_references (
    sak_nr TEXT REFERENCES kofa_cases,
    law_name TEXT,                  -- Normalisert: "anskaffelsesforskriften"
    law_section TEXT,               -- "8-3", "2-4 bokstav a"
    reference_type TEXT,            -- "lov" | "forskrift"
    lovdata_doc_id TEXT,            -- Kobling til lovdata_documents.dok_id
    regulation_version TEXT,        -- "old" (pre-2017) | "new" (2017+)
    raw_text TEXT                   -- Original tekst fra PDF
)

kofa_case_references (
    from_sak_nr TEXT REFERENCES kofa_cases,
    to_sak_nr TEXT,                 -- TEXT, ikke FK (referert sak finnes kanskje ikke)
    paragraph_number INT
)

-- EU-domstolsreferanser (005_eu_references.sql)
kofa_eu_references (
    sak_nr TEXT REFERENCES kofa_cases,
    eu_case_id TEXT,                -- "C-19/00"
    eu_case_name TEXT,              -- "SIAC Construction" (kan være NULL)
    paragraph_number INT
)
```

### Indekser

- **FTS:** GIN på `kofa_cases.fts` for fulltekstsøk
- **Trigram:** GIN på `innklaget`/`klager` for fuzzy matching
- **Oppslag:** B-tree på `(law_name, law_section)`, `sak_nr`, `lovdata_doc_id`
- **Kryssref:** B-tree på `from_sak_nr`, `to_sak_nr`
- **EU-ref:** B-tree på `eu_case_id`, `sak_nr`

### RLS

Alle tabeller har Row Level Security:
- **Lesing:** Offentlig (public read)
- **Skriving:** Kun `service_role`

---

## ADR-001.3: Arkitektur og lagdeling

### Beslutning

Tre-lags arkitektur med klar ansvarsfordeling:

```
CLI (cli.py) → Service (service.py) → Backend (supabase_backend.py)
     ↓                                        ↑
MCP Server (server.py) ──────────────────────→│
     ↓
Flask Blueprint (web.py) → HTTP POST /mcp/kofa/
```

| Lag | Fil | Ansvar |
|-----|-----|--------|
| **CLI** | `cli.py` | Kommandolinje: `kofa sync`, `kofa sync --pdf`, `kofa sync --references` |
| **Service** | `service.py` | Forretningslogikk, formatering, alias-normalisering |
| **Backend** | `supabase_backend.py` | Database-operasjoner, PostgREST queries |
| **MCP Server** | `server.py` | JSON-RPC protokoll, verktøy-definisjon |
| **Web** | `web.py` | Flask blueprint for HTTP MCP-transport |
| **Ekstraksjon** | `reference_extractor.py` | Regex-basert referanse-ekstraksjon fra PDF-tekst |
| **PDF** | `pdf_extractor.py` | Strukturert ekstraksjon av avgjørelsestekst fra PDF |

### MCP-verktøy

| Verktøy | Beskrivelse |
|---------|-------------|
| `sok(query, limit?)` | Fulltekstsøk i saker |
| `hent_sak(sak_nr)` | Hent en spesifikk sak med alle detaljer |
| `hent_avgjoerelse(sak_nr, seksjon?)` | Hent avgjørelsestekst (innledning, bakgrunn, anførsler, vurdering, konklusjon) |
| `siste_saker(limit?, sakstype?, avgjoerelse?, innklaget?)` | Siste avgjørelser med filtre |
| `finn_praksis(lov, paragraf?, limit?)` | Finn saker som refererer til en bestemt lovparagraf (2017+) |
| `relaterte_saker(sak_nr)` | Kryssreferanser: saker denne saken siterer og saker som siterer denne |
| `mest_siterte(limit?)` | De mest siterte/prinsipielle KOFA-sakene |
| `eu_praksis(eu_case_id, limit?)` | Finn KOFA-saker som refererer til en bestemt EU-dom |
| `mest_siterte_eu(limit?)` | De mest siterte EU-dommene i KOFA |
| `statistikk(aar?, gruppering?)` | Aggregert statistikk |

### Deployment

KOFA MCP eksponeres som Flask blueprint registrert i unified-timeline:

```python
# backend/app.py
from kofa.web import create_mcp_blueprint as create_kofa_mcp_blueprint
app.register_blueprint(create_kofa_mcp_blueprint(), url_prefix="/mcp/kofa")
```

URL: `https://unified-timeline.onrender.com/mcp/kofa/`

### MCP-instruksjoner

Serveren inkluderer detaljerte instruksjoner som sendes til klienter (LLM) ved tilkobling.
Instruksjonene er designet for å styre LLM-atferd, ikke bare dokumentere API:

| Aspekt | Innhold |
|--------|---------|
| Verktøyvalg | Beslutningstabell: "Bruk `finn_praksis` for lovparagraf, `sok` for tema" |
| Arbeidsflyt | Steg-for-steg: finn praksis → hent detaljer → slå opp lovtekst |
| Utforskning | "ALLTID tilby videre utforskning etter å ha besvart" |
| Samspill | Når bruke KOFA vs Paragraf MCP (tabell) |
| Aliaser | FOA/LOA/forskriften/loven → kanoniske lovnavn |
| Begrensninger | Kun 2017+ for lovhenvisninger, ikke rettsavgjørelser, sammendrag vs fulltekst |

Se `server.py:SERVER_INSTRUCTIONS` for full tekst

---

## ADR-001.4: Referanse-ekstraksjon (Phase 2)

### Kontekst

KOFA-avgjørelser refererer hyppig til lover, forskrifter og tidligere KOFA-saker. For å muliggjøre `finn_praksis`-oppslag (f.eks. "finn alle saker om FOA § 8-3") må disse referansene ekstraheres strukturert.

### Alternativer vurdert

| Alternativ | Presisjon | Recall | Kompleksitet |
|------------|-----------|--------|--------------|
| A: LLM-basert ekstraksjon | Høy | Høy | Høy (kostnad, latens) |
| B: Regex-basert ekstraksjon | Høy | Medium-høy | Medium |
| C: Enkel substring-matching | Lav | Høy | Lav |

### Beslutning

**Valgt: B - Regex-basert ekstraksjon med normalisering**

### Begrunnelse

- **Presisjon:** Regex gir svært få falske positiver for strukturerte referanser som `§ X-Y`
- **Kostnad:** Ingen API-kall, ren Python
- **Hastighet:** ~1000 saker/minutt
- **Vedlikehold:** Nye mønstre kan legges til inkrementelt

### Regex-mønstre

Fem mønstergrupper med dedup via `seen`-sett:

| Mønster | Eksempel | Beskrivelse |
|---------|----------|-------------|
| 1: Named law + § | `anskaffelsesforskriften § 8-3 (1)` | Lovnavn etterfulgt av paragraf |
| 1b: Abbreviation + § | `FOA § 8-3`, `LOA § 4` | Forkortelse med §-tegn |
| 1c: Abbreviation uten § | `FOA 7-9 (2)` | Forkortelse uten §, krever bindestrek |
| 2: Descriptive | `forskrift om klagenemnd for offentlige anskaffelser § 6` | "lov/forskrift om ..." |
| 3: Case reference | `sak 2019/491`, `klagenemndas sak 2020/172` | KOFA-kryssreferanser |
| 4: EU case | `C-19/00 SIAC Construction`, `C-368/10 (Max Havelaar)` | EU-domstolsreferanser med navnekstraksjon |

### Normalisering

Alle lovnavn normaliseres til kanonisk form via `LAW_ALIASES`:

```python
LAW_ALIASES = {
    "forskriften": "anskaffelsesforskriften",
    "loven": "anskaffelsesloven",
    "foa": "anskaffelsesforskriften",
    "loa": "anskaffelsesloven",
    "anskaffelseslova": "anskaffelsesloven",
    "klagenemndforskriften": "klagenemndsforskriften",  # typo
    # ... 20+ aliaser inkl. nynorsk, typos, forkortelser
}
```

Substring-matching er begrenset til multi-ord-aliaser for å unngå falske positiver (`"forskriften"` i `"forsyningsforskriften"` → ignoreres).

### Reguleringsversjon (gammel/ny forskrift)

Ny anskaffelseslov (2016-06-17-73) og ny forskrift (2016-08-12-974) trådte i kraft 1.1.2017. KOFA-saker fra overgangsperioden (2017-2019) kan anvende enten gammelt eller nytt regelverk. Deteksjon per sak via `detect_regulation_version()`:

| Signal | Klassifisering |
|--------|---------------|
| Eksplisitt ny lov/forskrift (dato/nr) | `new` |
| Eksplisitt gammel + eksplisitt ny | `new` (gammel er historisk kontekst) |
| "den tidligere" / "dagjeldende" i 2018+ | `new` (historisk kontekst) |
| "den tidligere" / "dagjeldende" i 2017 | `old` (overgangsperiode) |
| Ingen signaler + saksnr ≤ 2016 | `old` |
| Ingen signaler + saksnr ≥ 2017 | `new` |

### lovdata_doc_id-oppløsning

Referanser kobles til paragraf (Lovdata MCP) via `lovdata_documents.dok_id`:

| Strategi | Dekning |
|----------|---------|
| Hardkodede `KNOWN_DOK_IDS` for nye (2016+) kjernelover | anskaffelsesforskriften, anskaffelsesloven, klagenemndsforskriften, offentleglova |
| `_OLD_DOK_IDS` for gamle forskrifter | anskaffelsesforskriften (2006-04-07-402), anskaffelsesloven (1999-07-16-69) |
| Dynamisk oppslag via `ilike` for øvrige | Avhenger av om loven er i lovdata-cache |

### Synkresultater (2026-02-08)

| Metrikk | Verdi |
|---------|-------|
| Saker prosessert | 1364 |
| Lovhenvisninger | 4152 |
| Sakskryssreferanser | 2032 |
| EU-referanser | 772 |
| Unike EU-saker | 138 |
| KOFA-saker med EU-ref | 470 |
| Reguleringsversjon old | 114 (2.7%) |
| Reguleringsversjon new | 4038 (97.3%) |

### Fordeling lovhenvisninger

| Lov | Antall | lovdata_doc_id |
|-----|--------|----------------|
| klagenemndsforskriften | 2221 | 100% |
| anskaffelsesloven | 757 | 100% |
| anskaffelsesforskriften | 717 | 100% |
| forsyningsforskriften | 226 | 0% (ikke i lovdata-cache) |
| forvaltningsloven | 139 | 100% |
| offentleglova | 54 | 100% |
| konsesjonskontraktforskriften | 31 | 0% (ikke i lovdata-cache) |
| tvisteloven | 4 | 0% |
| konkurranseloven | 2 | 100% |
| sikkerhetsloven | 1 | 0% |

### Topp 5 EU-dommer i KOFA

| EU-sak | Navn | KOFA-siteringer |
|--------|------|-----------------|
| C-19/00 | SIAC Construction | 108 |
| C-6/15 | Dimarso | 49 |
| C-42/13 | Cartiera dell'Adda | 46 |
| C-368/10 | Max Havelaar | 40 |
| C-27/15 | Pippo Pizzo | 34 |

### Datakvalitet og kjente edge cases

Verifisert 2026-02-08 via direkte SQL-analyse mot produksjonsdata:

**Funnet og fikset:**

| Problem | Antall | Fix |
|---------|--------|-----|
| Selv-referanser i sakskryssreferanser | 4 | Filter `from_sak_nr != to_sak_nr` i Python + SQL-sletting |
| Linjeskift i EU-saksnavn (PDF-artefakt) | 35 | `_clean_eu_case_name()` stripper `\n` og sidetall |
| Trailing connector i EU-navn ("Montte og") | 6 | Strip trailing `og`/`mot`/`v.`/`et` |
| LOA→FOA misattribusjon | 6 | KOFA skriver noen ganger "loven" for forskrift-seksjoner. Automatisk korreksjon: LOA-ref med sammensatt seksjon (§ 24-8) eller seksjon > 18 remappes til FOA |
| EU appeal-suffiks "P" som saksnavn | 4 | Forkast entegns-navn (C-677/15P → "P" er ikke et saksnavn) |
| Feilsiterte EU-IDer i kildetekst | 5 | C-15/6→C-6/15, C-19/99→C-19/00 (korrigert i SQL) |

**Kjent og akseptert:**

| Observasjon | Antall | Vurdering |
|-------------|--------|-----------|
| Dangling cross-refs (peker til pre-2017-saker) | 256 | Forventet — vi har ikke beslutnings-tekst for eldre saker |
| Saker med tekst men null referanser | 27 | Korte avvisningssaker uten lovhenvisninger |
| EU-navnevarianter per case_id | ~10 saker | Korrekt oppførsel — kildetekst varierer ("SIAC" vs "SIAC Construction") |
| "Max Havelaar og Rt" (2 stk) | 2 | "Rt." (Rettstidende) fanges som del av navn — ikke verdt spesialregel |

### Scope-avgrensning

Referanse-ekstraksjon dekker saker fra **2017+**:
- Gjeldende anskaffelseslov/forskrift trådte i kraft 1.1.2017
- Saker fra 2017 som anvender gammel lov merkes med `regulation_version = "old"` (14 saker med FOA/LOA)
- 2018+ saker med "den tidligere"/"dagjeldende" klassifiseres som `new` (historisk kontekst)
- PDF-ekstraksjon dekker alle saker med PDF
- Ny anskaffelseslov er ventet i 2026 — vil kreve nye lovdata_doc_id og evt. tilpasning av seksjonsnummerlogikk

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | `finn_praksis("anskaffelsesforskriften", "8-3")` gir presise treff |
| Positiv | Kobling mellom KOFA og paragraf MCP via lovdata_doc_id |
| Positiv | Sakskryssreferanser muliggjør `relaterte_saker` og `mest_siterte` |
| Positiv | Reguleringsversjon skiller gammel/ny forskrift i overgangsperioden |
| Positiv | EU-referanser med navnekstraksjon muliggjør `eu_praksis` og `mest_siterte_eu` |
| Positiv | Automatisk LOA→FOA-korreksjon håndterer feil i kildetekst |
| Negativ | Regex fanger ikke alle formuleringsmåter (f.eks. "nevnte bestemmelse") |
| Negativ | Kun 2017+ saker dekkes for lovhenvisninger |

---

## ADR-001.5: Sync-strategi

### Pipeline

```
kofa sync                        # Steg 1: WP API → kofa_cases (metadata)
kofa sync --scrape               # Steg 1b: HTML scraping (innklaget, sakstype, etc.)
kofa sync --pdf                  # Steg 2: PDF → kofa_decision_text (fulltekst)
kofa sync --references           # Steg 3: Regex → kofa_law/case_references
kofa sync --references --force   # Re-ekstraher alle (etter regex-endringer)
```

### Inkrementell sync

- **WP API:** Paginerer med `per_page=100`, lagrer cursor i `kofa_sync_meta`
- **PDF:** Hopper over saker som allerede har rader i `kofa_decision_text`
- **Referanser:** Hopper over saker som allerede har rader i `kofa_law_references` (med mindre `--force`)

### Graceful shutdown

Referanse-sync har signalhåndtering (`SIGINT`/`SIGTERM`) som setter `_shutdown_requested`-flagg. Pågående sak fullføres, deretter avsluttes rent med oppsummering.

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Inkrementell - trenger ikke re-synce alt |
| Positiv | `--force` for å re-ekstrahere etter regex-endringer |
| Positiv | Graceful shutdown bevarer dataintegritet |
| Negativ | Tre separate steg krever manuell orkestrering |

---

## ADR-001.6: Datadekning og veien videre

### Nåværende datadekning (2026-02-08)

| Pipeline | Rader | Dekning |
|----------|------:|---------|
| Saker (WP API) | 4 652 | 100% (baseline) |
| Scraping (HTML) | 3 403 | 73% av saker |
| PDF-ekstraksjon | 1 971 | 42% (66% av de med PDF-URL) |
| Avgjørelsestekst | 1 961 saker, 79 658 avsnitt | |
| Lovreferanser | 4 152 | 1 328 unike saker |
| Sakskryssreferanser | 2 032 | 912 unike saker |
| EU-referanser | 772 | 470 unike saker |

#### Seksjonfordeling i avgjørelsestekst

| Section | Avsnitt |
|---------|--------:|
| vurdering | 36 961 |
| bakgrunn | 28 793 |
| anfoersler | 13 274 |
| innledning | 540 |
| raw | 59 |
| konklusjon | 31 |

#### Indeksering

| Tabell | FTS | Vektorsøk |
|--------|-----|-----------|
| `kofa_cases` | `fts` (vektet tsvector) | Ingen |
| `kofa_decision_text` | Ingen | Ingen |
| `lovdata_sections` (referanse) | `search_vector` + GIN | `embedding` VECTOR(1536), 98% dekning, IVFFlat |

#### Ytelse `hent_avgjoerelse` (målt 2026-02-08)

Queries bruker `idx_kofa_decision_text_sak` (B-tree) med index scan. Ingen seq scans.

| Scenario | Execution time | Rader |
|----------|---------------|------:|
| TOC - typisk sak (84 avsnitt) | **0.20 ms** | 84 |
| Seksjon - typisk vurdering (63 avsnitt) | **0.20 ms** | 63 |
| Seksjon - største vurdering (75 avsnitt, ~10k tokens) | **0.24 ms** | 75 |
| TOC - største sak (147 avsnitt) | **0.32 ms** | 147 |

**Størrelsesdistribusjon (avsnitt per sak):**

| Percentil | Avsnitt |
|-----------|--------:|
| Median | 38 |
| P90 | 67 |
| P95 | 79 |
| P99 | 106 |
| Max | 216 |

**Token-størrelse:** Største vurderingsseksjon er ~10k tokens. Hele saker kan nå ~36k tokens (samlesaker fra 2012). TOC-modusen lar LLM velge seksjon og unngå unødvendig store kontekster.

**Dobbel-query:** `get_case()` + `get_decision_text()` gir ~2x nettverkslatens (~100-400ms totalt), neglisjerbart mot LLM-responstid. LIMIT 500 treffes aldri (max er 216).

**Tabellstørrelse:** 57 MB data + 5 MB indekser. Ingen ytelsestiltak nødvendige.

### Veien videre

| Fase | Beskrivelse | Status |
|------|-------------|--------|
| A: `hent_avgjoerelse` | MCP-verktøy for å lese avgjørelsestekst | Implementert |
| B: FTS på avgjørelsestekst | `search_vector` + GIN-indeks på `kofa_decision_text` | Planlagt |
| C: Vektorsøk (embedding) | pgvector embeddings + hybrid søk (som lovdata) | Planlagt |

**Fase B** legger til fulltekstsøk direkte i avgjørelsesteksten (ikke bare metadata). Krever:
- Migration: `search_vector TSVECTOR` kolonne + GIN-indeks + trigger
- RPC-funksjon `search_kofa_decision_text(query, section?, limit)`
- MCP-verktøy `sok_avgjoerelse(query, seksjon?, limit?)`

**Fase C** muliggjør semantisk søk med naturlig språk. Krever:
- Migration: `embedding VECTOR(1536)` kolonne + IVFFlat-indeks
- Embedding-script (Gemini, ~80k avsnitt, ~$2)
- RPC-funksjon `search_kofa_hybrid(query, section?, limit?)`
- MCP-verktøy `semantisk_sok_kofa(query, seksjon?, limit?)`
- Kan gjenbruke mønsteret fra lovdata (`search_lovdata_hybrid`)

---

## Referanser

- [KOFA - Klagenemnda for offentlige anskaffelser](https://www.klagenemndssekretariatet.no/)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [Paragraf ADR-001](../../paragraf/docs/ADR-001.md) - Lovdata MCP arkitektur
